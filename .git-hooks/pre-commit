#!/usr/bin/env bash
# Branding Lockdown Pre-commit Hook
# Blocks commits containing any branding customization references
# Install: chmod +x .git/hooks/pre-commit

set -euo pipefail

echo ""
echo "ğŸ”’ Branding Lockdown Pre-commit Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

VIOLATIONS=0

# Check 1: ripgrep scan
echo "1ï¸âƒ£  Scanning for blocked terms..."
if command -v rg >/dev/null 2>&1; then
  if [ -f .branding-blocklist.txt ]; then
    if rg -n --ignore-case --hidden -f .branding-blocklist.txt . \
      --glob '!package-lock.json' \
      --glob '!.next/**' \
      --glob '!dist/**' \
      --glob '!node_modules/**' \
      --glob '!venv/**' \
      --glob '!**/*.png' \
      --glob '!**/*.jpg' 2>&1 | grep -v "^$"; then
      echo "   âŒ Branding terms found in staged files"
      VIOLATIONS=$((VIOLATIONS + 1))
    else
      echo "   âœ… No blocked terms found"
    fi
  else
    echo "   âš ï¸  .branding-blocklist.txt not found"
    VIOLATIONS=$((VIOLATIONS + 1))
  fi
else
  echo "   âš ï¸  ripgrep not installed, skipping grep scan"
fi

# Check 2: Python scanner
echo "2ï¸âƒ£  Running Python scanner..."
if [ -f tools/branding_scan.py ]; then
  if python3 tools/branding_scan.py > /dev/null 2>&1; then
    echo "   âœ… Python scan passed"
  else
    echo "   âŒ Python scan failed"
    VIOLATIONS=$((VIOLATIONS + 1))
  fi
else
  echo "   âš ï¸  tools/branding_scan.py not found"
  VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check 3: Semgrep (optional but recommended)
echo "3ï¸âƒ£  Running Semgrep structural checks..."
if command -v semgrep >/dev/null 2>&1; then
  if [ -f semgrep/branding.yml ]; then
    if semgrep --quiet --config semgrep/branding.yml --error 2>&1 | grep -q "findings"; then
      echo "   âŒ Semgrep found violations"
      VIOLATIONS=$((VIOLATIONS + 1))
    else
      echo "   âœ… Semgrep passed"
    fi
  else
    echo "   âš ï¸  semgrep/branding.yml not found"
  fi
else
  echo "   â„¹ï¸  Semgrep not installed (optional check)"
fi

# Check 4: Verify brandPolicy.ts constant
echo "4ï¸âƒ£  Verifying policy constant..."
if [ -f tregu_frontend/lib/brandPolicy.ts ]; then
  if grep -q "BRANDING_CUSTOMIZATION_ENABLED = true" tregu_frontend/lib/brandPolicy.ts; then
    echo "   âŒ BRANDING_CUSTOMIZATION_ENABLED is set to true!"
    VIOLATIONS=$((VIOLATIONS + 1))
  else
    echo "   âœ… Policy constant is correct"
  fi
else
  echo "   âš ï¸  brandPolicy.ts not found"
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $VIOLATIONS -gt 0 ]; then
  echo ""
  echo "âŒ COMMIT BLOCKED: Branding policy violations detected"
  echo ""
  echo "Branding customization is FORBIDDEN by system policy."
  echo "Remove all branding/theming references before committing."
  echo ""
  echo "If you believe this is a false positive, contact the platform team."
  echo ""
  exit 1
else
  echo ""
  echo "âœ… All branding lockdown checks passed"
  echo "   Proceeding with commit..."
  echo ""
  exit 0
fi
